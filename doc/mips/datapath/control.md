# 控制器

## 主要功能

负责对整个流水线进行控制，包括以下工作：

1. 接受来自总线和多周期运算器的停顿信号；
2. 接受来自异常处理模块的异常信号；
3. 控制PC寄存器；
4. 控制各个流水线寄存器的停顿、刷新；
5. 实现数据前推。

## 接口定义

### 1

| 信号     | 方向 | 位宽 | 线号   | 描述                                     |
| -------- | ---- | ---- | ------ | ---------------------------------------- |
| ib_stall | 输入 | 1    | IF.C.2 | 来自指令总线的停顿信号，高电平有效，下同 |
| db_stall | 输入 | 1    | MM.C.2 | 来自数据总线的停顿信号                   |
| ex_stall | 输入 | 1    | EX.C.2 | 来自EX阶段多周期运算器的停顿信号         |

### 2

暂未实现

### 3

| 信号           | 方向 | 位宽   | 线号   | 描述                           |
| -------------- | ---- | ------ | ------ | ------------------------------ |
| pc_enable      | 输出 | 1      | IF.C.1 | PC寄存器的停顿信号，低电平有效 |
| pc_except      | 输出 | 1      | IF.A.1 | 异常处理目标地址是否有效       |
| pc_except_addr | 输出 | W_ADDR | IF.A.1 | 异常处理目标地址               |

参见PC寄存器的文档。

### 4

| 信号     | 方向 | 位宽 | 描述                                    |
| -------- | ---- | ---- | --------------------------------------- |
| stall_fd | 输出 | 1    | IF-ID间寄存器停顿信号，高电平有效，下同 |
| stall_de | 输出 | 1    | ID-EX间寄存器停顿信号                   |
| stall_em | 输出 | 1    | EX-MM间寄存器停顿信号                   |
| stall_mw | 输出 | 1    | MM-WB间寄存器停顿信号                   |
| flush_fd | 输出 | 1    | IF-ID间寄存器刷新信号，高电平有效，下同 |
| flush_de | 输出 | 1    | ID-EX间寄存器刷新信号                   |
| flush_em | 输出 | 1    | EX-MM间寄存器刷新信号                   |
| flush_mw | 输出 | 1    | MM-WB间寄存器刷新信号                   |

关于控制冒险：由于延迟槽指令的存在，无需处理控制冒险。

关于数据冒险，参见下一节。

### 5

| 信号            | 方向 | 位宽   | 线号   | 描述                                               |
| --------------- | ---- | ------ | ------ | -------------------------------------------------- |
| ex_regf         | 输入 | W_REGF | EX.C.1 | 来自EX阶段的前推寄存器号，如无则为零，下同         |
| ex_data         | 输入 | W_DATA | EX.D.2 | 来自EX阶段的前推数据                               |
| mm_regf         | 输入 | W_REGF | MM.C.1 | 来自MM阶段的前推寄存器号                           |
| mm_data         | 输入 | W_DATA | MM.D.1 | 来自MM阶段的前推数据                               |
| wb_regf         | 输入 | W_REGF | WB.C.1 | 来自WB阶段的前推寄存器号                           |
| wb_data         | 输入 | W_DATA | WB.D.2 | 来自WB阶段的前推数据                               |
| id_rs           | 输入 | W_REGF | ID.C.1 | ID阶段需要读的第一个寄存器号                       |
| id_rd           | 输入 | W_REGF | ID.C.1 | ID阶段需要读的第二个寄存器号                       |
| forward_rs      | 输出 | 1      | ID.D.1 | 向ID阶段前推的第一个数据的有效性，高电平有效，下同 |
| forward_rs_data | 输出 | W_DATA | ID.D.1 | 向ID阶段前推的第一个数据                           |
| forward_rd      | 输出 | 1      | ID.D.1 | 向ID阶段前推的第二个数据的有效性                   |
| forward_rd_data | 输出 | W_DATA | ID.D.1 | 向ID阶段前推的第二个数据                           |

假设指令A此时位于ID阶段，需要数据前推，那么：

1. 一般情况：A指令需要的数据已经计算出来，但尚未写回，那么直接从EX、MM、WB前推回来即可，不需要停顿。WB阶段也需要前推的原因是写入寄存器的数据需要到下一个周期才有效；
2. 特殊情况：A指令需要的数据尚未计算出来，那么产生这些数据的指令一定位于EX阶段，且一定是读内存指令；此时需要停顿IF、ID阶段，放行EX、MM、WB阶段，并在ID和EX阶段间插入一个气泡。

